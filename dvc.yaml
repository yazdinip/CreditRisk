stages:
  ingest_data:
    cmd: python -X faulthandler -m creditrisk.pipelines.ingest_data --config configs/creditrisk_pd.yaml
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/pipelines/ingest_data.py
    outs:
      - reports/ingestion_summary.json

  build_feature_store:
    cmd: python -X faulthandler -m creditrisk.pipelines.build_feature_store --config configs/creditrisk_pd.yaml
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/data/datasets.py
      - src/creditrisk/features/feature_store.py
      - src/creditrisk/features/preprocess.py
      - src/creditrisk/pipelines/build_feature_store.py
      - src/creditrisk/pipelines/data_workflow.py
      - src/creditrisk/validation/contracts.py
      - src/creditrisk/validation/runner.py
      - reports/ingestion_summary.json
      - data/raw/application_train.csv
      - data/raw/bureau.csv
      - data/raw/bureau_balance.csv
      - data/raw/previous_application.csv
      - data/raw/installments_payments.csv
      - data/raw/credit_card_balance.csv
      - data/raw/POS_CASH_balance.csv
    outs:
      - data/processed/feature_store.parquet

  split_data:
    cmd: python -X faulthandler -m creditrisk.pipelines.split_data --config configs/creditrisk_pd.yaml
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/data/datasets.py
      - src/creditrisk/pipelines/split_data.py
      - src/creditrisk/pipelines/data_workflow.py
      - src/creditrisk/validation/contracts.py
      - src/creditrisk/validation/runner.py
      - data/processed/feature_store.parquet
    outs:
      - data/processed/train.parquet
      - data/processed/test.parquet

  fit_model:
    cmd: python -X faulthandler -m creditrisk.pipelines.train_creditrisk_pd --config configs/creditrisk_pd.yaml --skip-artifacts
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/data/datasets.py
      - src/creditrisk/features/preprocess.py
      - src/creditrisk/models/creditrisk_pd.py
      - src/creditrisk/pipelines/train_creditrisk_pd.py
      - src/creditrisk/pipelines/data_workflow.py
      - src/creditrisk/validation/contracts.py
      - src/creditrisk/validation/runner.py
      - data/processed/train.parquet
      - data/processed/test.parquet
    params:
      - configs/creditrisk_pd.yaml:
          - data.raw_path
          - data.target_column
          - training.test_size
          - training.random_state
          - training.class_weight
          - model.type
    outs:
      - models/creditrisk_pd_model.joblib

  evaluate_train:
    cmd: python -X faulthandler -m creditrisk.testing.test_dataset --config configs/creditrisk_pd.yaml --split train --skip-predictions
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/testing/test_dataset.py
      - src/creditrisk/data/datasets.py
      - src/creditrisk/pipelines/data_workflow.py
      - src/creditrisk/models/creditrisk_pd.py
      - src/creditrisk/utils/evaluation.py
      - models/creditrisk_pd_model.joblib
      - data/processed/train.parquet
    outs:
      - reports/metrics.json
      - reports/evaluation

  evaluate_test:
    cmd: python -X faulthandler -m creditrisk.testing.test_dataset --config configs/creditrisk_pd.yaml --split test --metrics-file reports/test_metrics.json --predictions-file reports/test_predictions.parquet --evaluation-dir reports/test_evaluation
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/testing/test_dataset.py
      - src/creditrisk/data/datasets.py
      - src/creditrisk/pipelines/data_workflow.py
      - src/creditrisk/models/creditrisk_pd.py
      - src/creditrisk/utils/evaluation.py
      - models/creditrisk_pd_model.joblib
      - data/processed/test.parquet
    outs:
      - reports/test_metrics.json
      - reports/test_predictions.parquet
      - reports/test_evaluation

  validate_model:
    cmd: python -X faulthandler -m creditrisk.testing.post_training --config configs/creditrisk_pd.yaml --metrics-file reports/test_metrics.json --evaluation-dir reports/test_evaluation
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/testing/post_training.py
      - reports/test_metrics.json
      - reports/test_evaluation
      - mlruns
    outs:
      - reports/post_training_validation.json

  register_model:
    cmd: python -X faulthandler -m creditrisk.pipelines.auto_promote --config configs/creditrisk_pd.yaml --stage Production --report reports/registry_promotion.json --transition-log reports/registry_transition.json
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/pipelines/auto_promote.py
      - src/creditrisk/mlops/registry.py
      - reports/post_training_validation.json
      - reports/registry_promotion.json
      - reports/metrics.json
      - reports/evaluation
      - reports/test_metrics.json
      - reports/test_evaluation
      - reports/drift_report.json
      - reports/drift_report.html
      - reports/canary_report.json
    outs:
      - reports/registry_transition.json

  deploy_manifest:
    cmd: python -X faulthandler -m creditrisk.pipelines.deploy_manifest --config configs/creditrisk_pd.yaml --output reports/deploy_manifest.json
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/pipelines/deploy_manifest.py
      - Dockerfile.api
      - Dockerfile.batch
      - .github/workflows/cd.yaml
      - reports/registry_transition.json
      - reports/canary_report.json
    outs:
      - reports/deploy_manifest.json

  monitor_drift:
    cmd: python -X faulthandler -m creditrisk.monitoring.drift --config configs/creditrisk_pd.yaml
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/monitoring/__init__.py
      - src/creditrisk/monitoring/drift.py
      - src/creditrisk/pipelines/data_workflow.py
      - data/processed/train.parquet
      - data/processed/test.parquet
    outs:
      - reports/drift_report.json
      - reports/drift_report.html

  canary_validation:
    cmd: python -X faulthandler -m creditrisk.pipelines.canary_validation --config configs/creditrisk_pd.yaml --candidate-model models/creditrisk_pd_model.joblib --dataset data/processed/test.parquet --output reports/canary_report.json
    deps:
      - configs/creditrisk_pd.yaml
      - src/creditrisk/config.py
      - src/creditrisk/pipelines/canary_validation.py
      - src/creditrisk/prediction/helpers.py
      - src/creditrisk/pipelines/data_workflow.py
      - models/creditrisk_pd_model.joblib
      - data/processed/test.parquet
    outs:
      - reports/canary_report.json
